<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS Tracking - DMS Toggle</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
    }
    .map-container {
      margin: 1rem 0;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
    }
    .status {
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h2>GPS Tracker</h2>

  <label>
    <input type="checkbox" id="toggleDMS" />
    Use DMS Format (like Google Maps: 7°16'37.9"S 112°43'26.8"E)
  </label>

  <div id="decimalInputs">
    <input type="text" id="targetLat" placeholder="Target Latitude (e.g. -7.2772)" />
    <input type="text" id="targetLng" placeholder="Target Longitude (e.g. 112.7241)" />
  </div>

  <div id="dmsInput" style="display: none;">
    <input type="text" id="targetDMS" placeholder="Paste Google Maps format (e.g. 7°16'37.9\"S 112°43'26.8\"E)" style="width: 100%;" />
  </div>

  <br/>
  <label>Radius Tolerance (meters):</label>
  <input type="number" id="radius" value="100" />
  <br/><br/>
  <button onclick="startTracking()">Start Tracking</button>

  <div class="map-container">
    <iframe id="map" loading="lazy"></iframe>
  </div>

  <div class="status" id="status">Status: Not Tracking</div>

  <script>
    const toggle = document.getElementById("toggleDMS");
    const dmsInput = document.getElementById("dmsInput");
    const decimalInputs = document.getElementById("decimalInputs");

    toggle.addEventListener("change", () => {
      if (toggle.checked) {
        dmsInput.style.display = "block";
        decimalInputs.style.display = "none";
      } else {
        dmsInput.style.display = "none";
        decimalInputs.style.display = "block";
      }
    });

    function parseDMS(input) {
      const regex = /(\d+)[°\s]+(\d+)[′']+([\d.]+)[″"]?\s*([NSEW])/gi;
      let parts = input.match(regex);
      if (!parts || parts.length !== 2) return null;

      const toDecimal = (str) => {
        const match = str.match(/(\d+)[°\s]+(\d+)[′']+([\d.]+)[″"]?\s*([NSEW])/i);
        if (!match) return null;

        let deg = parseFloat(match[1]);
        let min = parseFloat(match[2]);
        let sec = parseFloat(match[3]);
        let dir = match[4].toUpperCase();

        let dec = deg + min / 60 + sec / 3600;
        if (dir === "S" || dir === "W") dec *= -1;
        return dec;
      };

      const lat = toDecimal(parts[0]);
      const lng = toDecimal(parts[1]);
      return { lat, lng };
    }

    function getTargetCoordinates() {
      if (toggle.checked) {
        const parsed = parseDMS(document.getElementById("targetDMS").value);
        if (!parsed) {
          alert("Invalid DMS input.");
          return null;
        }
        return parsed;
      } else {
        const lat = parseFloat(document.getElementById("targetLat").value);
        const lng = parseFloat(document.getElementById("targetLng").value);
        if (isNaN(lat) || isNaN(lng)) {
          alert("Please enter valid decimal coordinates.");
          return null;
        }
        return { lat, lng };
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Radius of the Earth in meters
      const dLat = (lat2 - lat1) * (Math.PI / 180);
      const dLon = (lon2 - lon1) * (Math.PI / 180);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) *
        Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function showPosition(position, targetLat, targetLng, radius) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const iframe = document.getElementById("map");
      iframe.src = `https://www.google.com/maps?q=${lat},${lon}&z=18&t=k&output=embed`;

      const distance = calculateDistance(lat, lon, targetLat, targetLng);
      const status = document.getElementById("status");
      status.textContent = distance <= radius
        ? "✅ Within Radius"
        : "❌ Outside Radius";
    }

    function startTracking() {
      const coords = getTargetCoordinates();
      if (!coords) return;

      const radius = parseFloat(document.getElementById("radius").value);
      if (isNaN(radius) || radius <= 0) {
        alert("Please enter a valid radius.");
        return;
      }

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          pos => showPosition(pos, coords.lat, coords.lng, radius),
          err => alert("Location error: " + err.message),
          { enableHighAccuracy: true }
        );
        document.getElementById("status").textContent = "📡 Tracking...";
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }
  </script>
</body>
</html>
